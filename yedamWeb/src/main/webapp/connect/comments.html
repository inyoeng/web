<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Coments.htlm</title>
	<script>
		window.onload = function () {
			loadCommentList();
		}

		//목록조회
		function loadCommentList() {
			//ajax호출, surerlet 호출...
			let xhtp = new XMLHttpRequest();
			xhtp.open('get', '../CommentServlet?cmd=selectAll');
			xhtp.send();
			xhtp.onreadystatechange = loadCommentResult;
		}

		//조회결과

		function loadCommentResult() {
			if (this.readyState == 4 && this.status == 200) {
				// string -> xml
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');
				let code = xmlDoc.getElementsByTagName('code')[0].innerHTML;
				let listDiv = document.getElementById('commentList');
				if (code == 'success') {
					let commentList = eval(xmlDoc.getElementsByTagName('data')[0].innerHTML);
					console.log(commentList);
					for (let i = 0; i < commentList.length; i++) {
						listDiv.appendChild(makeCommentView(commentList[i]));
					}
					//eval 쓰면 여러건으로 
				}
				console.log(xmlDoc);
			}
		}

		//한 건만 화면에 보이도록 하는 func
		function makeCommentView(comment) {
			let div = document.createElement('div');
			div.setAttribute('id', comment.id);
			div.className = 'comment';
			div.comment = comment; //div 테그에 comment속섬 만들고 거기에 실제 값 담기.{id:1, name:'user'}
			let str = '<strong>' +
				comment.name +
				'</strong>' +
				comment.content +
				'<input type= "button" value="수정" onclick="viewUpdateForm(' + comment.id + ')">' +
				'<input type="button" value="삭제" onclick="comfirmDeletion(' + comment.id + ')">';
			div.innerHTML = str; //<div><strong>str</strong></div>
			return div;
		}

		//한 건 등록 
		function addComment() {

			let name = addForm.name.value;
			if (name == "") {
				alert("이름을 입력하세요");
				addForm.name.focus();
				return;
			}

			let content = addForm.content.value;
			if (content == "") {
				alert("내용을 입력하세요");
				addForm.content.focus();
				return;
			}
			let param = "&name=" + name + "&content=" + content;
			//ajax호출
			let xhtp = new XMLHttpRequest();
			xhtp.open('get', '../CommentServlet?cmd=insert' + param);
			xhtp.send();
			xhtp.onreadystatechange = addResult;
		}

		//등록 콜백 함수
		function addResult() {
			if (this.readyState == 4 && this.status == 200) {
				// string -> xml
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');
				let code = xmlDoc.getElementsByTagName('code').item(0).innerHTML;
				let listDiv = document.getElementById("commentList");

				if (code == "success") {
					//let comment = eval( xmlDoc.getElementsByTagName('data').item(0).innerHTML);
					let comment = JSON.parse(xmlDoc.getElementByTagName('data').item(0).innerHTML)
					listDiv.appendChild(makeCommentView(comment));
					addForm.name.value = "";
					addForm.content.value = "";
					alert("등록했습니다! [" + comment.id + "]");
				} else if (code == "error") {
					alert("에러가 발생하였습니다.")
				}
				console.log(xmlDoc);
			}
		}

		//수정화면
		function viewUpdateForm(commentId) {
			let commentDiv = document.getElementById(commentId); //div테그 생성
			let updateFormDiv = document.getElementById('commentUpdate');

			commentDiv.appendChild(updateFormDiv); //수정 화면에 id기준 정보 보여주기 
			let comment = commentDiv.comment; //id, name, content 정보 불러                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			updateForm.id.value = comment.id;
			updateForm.name.value = comment.name;
			updateForm.content.value = comment.content;
			updateFormDiv.style.display = 'block';
		}

		//ajax호출 수정
		function updateComment(){
			
		}
	</script>

</head>

<body>
	<div id='commentList'></div>
	<!--!글등록-->
	<div id="commentAdd">
		<form action="" name="addForm">
			이름: <input type="text" name='name' size='10'><br>
			내용:<textarea name='content' cols='20' rows='2'></textarea>
			<input type="button" value='등록' onclick='addComment()'>
		</form>
	</div>

	<!-- 글 수정 -->
	<div id="commentUpdate" style='display: none'>
		<form action='' name="updateForm">
			<input type="hidden" name="id" value="">
			<!-- 아이디 받어온거 숨김 -->
			이름<input type="text" name='name' size='10'><br>
			내용:<textarea name='content' cols='20' rows='2'></textarea>
			<br> <input type="button" value='변경' onclick='updateComment()'>
			<input type="button" value='취소' onclick='cancleUpdate()'>
		</form>
	</div>
</body>

</html>